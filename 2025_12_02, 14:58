import streamlit as st
from openai import OpenAI
import numpy as np
import librosa
import whisper

st.set_page_config(page_title="Speakfit", layout="wide")

# -----------------------------
# ğŸ’¡ ì—¬ê¸°ì— ì§ì ‘ API Key ì…ë ¥
# -----------------------------
API_KEY = " "

st.title("Speakfit")

# -----------------------------
# GPT í˜¸ì¶œ í•¨ìˆ˜
# -----------------------------
@st.cache_data(show_spinner=True)
def ask_gpt(user_input):
    client = OpenAI(api_key=API_KEY)

    response = client.responses.create(
        model="gpt-5-mini",
        input=user_input
    )

    return response.output_text

# -------------------------------------------
# âœ¨ ë°œí‘œ ëŒ€ë³¸ êµì • ê¸°ëŠ¥
# -------------------------------------------
st.divider()
st.subheader("ğŸ“ ë°œí‘œ ëŒ€ë³¸ êµì •í•˜ê¸° (ë¬¸ì¥ íë¦„ / ìì—°ìŠ¤ëŸ¬ì›€ / ì „ë‹¬ë ¥ ê°•í™”)")

script_input = st.text_area(
    "ë°œí‘œ ëŒ€ë³¸ì„ ì…ë ¥í•˜ì„¸ìš”:",
    height=250,
    placeholder="ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”. ì˜¤ëŠ˜ì€ ì €í¬ íŒ€ì´ ê°œë°œí•œ ì„œë¹„ìŠ¤ë¥¼ ì†Œê°œí•˜ë ¤ê³  í•©ë‹ˆë‹¤..."
)

if st.button("ëŒ€ë³¸ êµì • ìš”ì²­"):
    if script_input.strip() == "":
        st.error("âŒ ë°œí‘œ ëŒ€ë³¸ì„ ì…ë ¥í•˜ì„¸ìš”.")
    else:
        prompt = f"""
        ì•„ë˜ ë°œí‘œ ëŒ€ë³¸ì„ ë” ìì—°ìŠ¤ëŸ½ê³  ë°œí‘œìš©ìœ¼ë¡œ ì í•©í•œ í‘œí˜„ìœ¼ë¡œ ìˆ˜ì •í•´ì¤˜.
        - ì „ë‹¬ë ¥ì„ ë†’ì´ê¸° ìœ„í•œ ë¦¬ë“¬ê³¼ ê°•ì•½ ì¡°ì ˆ í¬í•¨
        - ì²­ì¤‘ì´ ì´í•´í•˜ê¸° ì‰½ê²Œ ë‹¨ìˆœí™”
        - ì „ë¬¸ì ì¸ ëŠë‚Œ ìœ ì§€
        - ìˆ˜ì •ëœ ë²„ì „ + ê°œì„  ìš”ì•½ ì œê³µ

        ì›ë³¸ ë°œí‘œ ëŒ€ë³¸:
        {script_input}
        """

        corrected_script = ask_gpt(prompt)

        st.success("âœ¨ êµì •ëœ ë°œí‘œ ëŒ€ë³¸")
        st.write(corrected_script)


        # -----------------------------
# GPT í˜¸ì¶œ í•¨ìˆ˜
# -----------------------------
@st.cache_data(show_spinner=True)
def ask_gpt(user_input):
    client = OpenAI(api_key=API_KEY)

    response = client.responses.create(
        model="gpt-5-mini",
        input=user_input
    )

    return response.output_text


# -----------------------------
# ìŒì„± ë¶„ì„ í•¨ìˆ˜
# -----------------------------
@st.cache_data(show_spinner=True)
def analyze_audio(file_path):
    y, sr = librosa.load(file_path)

    duration = librosa.get_duration(y=y, sr=sr)         # ìŒì„± ê¸¸ì´
    tempo, _ = librosa.beat.beat_track(y, sr=sr)         # ë°œí™” ì†ë„ ê·¼ì‚¬ê°’
    pitch = np.mean(librosa.yin(y, fmin=80, fmax=400, sr=sr))  # í‰ê·  í”¼ì¹˜(ì–µì–‘)

    return {
        "duration(sec)": round(duration, 2),
        "tempo(beats/min)": round(tempo, 2),
        "avg_pitch(Hz)": round(float(pitch), 2),
    }


# -----------------------------
# Whisper STT
# -----------------------------
@st.cache_data(show_spinner=True)
def transcribe_audio(file_path):
    model = whisper.load_model("base")
    result = model.transcribe(file_path, language="ko")
    return result["text"]


# -----------------------------
# UI : ìŒì„± íŒŒì¼ ì—…ë¡œë“œ
# -----------------------------
st.divider()
st.subheader("ğŸ¤ ë°œí‘œ ì—°ìŠµ ìŒì„± ë¶„ì„")

uploaded_audio = st.file_uploader("ìŒì„± íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš” (mp3, wav, m4a)", type=["mp3", "wav", "m4a"])

if st.button("ìŒì„± ë¶„ì„ ì‹œì‘"):
    if uploaded_audio is None:
        st.error("âŒ ìŒì„± íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.")
    else:
        with open("uploaded_audio.wav", "wb") as f:
            f.write(uploaded_audio.read())

        st.audio("uploaded_audio.wav")

        st.info("â³ Whisperë¥¼ ì´ìš©í•œ ì „ì‚¬ ì²˜ë¦¬ ì¤‘...")
        transcript = transcribe_audio("uploaded_audio.wav")
        st.success("ğŸ“ ì „ì‚¬ ê²°ê³¼")
        st.write(transcript)

        st.info("â³ ìŒí–¥ ë¶„ì„ ì¤‘...")
        metrics = analyze_audio("uploaded_audio.wav")
        st.success("ğŸ“Š ìŒí–¥ ë°ì´í„° ë¶„ì„ ê²°ê³¼")
        st.json(metrics)

        prompt = f"""
        ì•„ë˜ ë°œí‘œìì˜ ìŒì„±ê³¼ ì „ì‚¬ëœ í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ
        ë°œí‘œ ì „ë‹¬ ë°©ì‹ì„ ê°œì„ í•  ìˆ˜ ìˆë„ë¡ ìƒì„¸í•œ í”¼ë“œë°±ì„ ì œê³µí•´ì¤˜.
        - ì–µì–‘(ë†’ë‚®ì´, ë‹¨ì¡°ë¡œì›€ ì—¬ë¶€) ê°œì„  ë°©ë²•
        - ë°œì„±(ëª…í™•ë„, ë°œìŒ ìŠµê´€)
        - ì†ë„(WPM ë˜ëŠ” tempo ê¸°ì¤€)
        - ì²­ì¤‘ ì „ë‹¬ë ¥ ê°•í™” íŒ 3ê°€ì§€
        - ìˆ˜ì •ëœ ë°œí‘œ ëŒ€ë³¸ ì˜ˆì‹œ ì œê³µ

        ì „ì‚¬ í…ìŠ¤íŠ¸:
        {transcript}

        ìŒí–¥ ë¶„ì„ ë°ì´í„°:
        {metrics}
        """

        feedback = ask_gpt(prompt)

        st.success("ğŸ¤– ë°œí‘œ ê°œì„  í”¼ë“œë°±")
        st.write(feedback)
